<!DOCTYPE html>
<html>

<head>
    <title>
        <%= title %>
    </title>
    <!-- <link rel='stylesheet' href='/stylesheets/style.css' /> -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>

<body>
    <!-- <h1>Backend User - List</h1> -->
    <!-- <input type='submit' value='Add' onclick="javascript: location.href='/BackendUser/AddBackendUser'"> -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <a class="navbar-brand" href="#">HeliumCryptic</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <span class="navbar-text">
                    歡迎
                    <%= UserID %>
                </span>
                <li class="nav-item" id="SignOut">
                    <a class="nav-link" href="#">登出</a>
                </li>
            </ul>
        </div>
    </nav>
    <!-- 後端使用者管理區 -->
    <div class="tableTitle bg-primary"
        style="width:100%;height:50px;line-height:50px;text-align: center;font-size:20px;color:white;border-top:0.5px solid white;">
        <span style="margin-left:15px;">後台使用者管理</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <tr class="bg-primary" style="color:white;">
                <th>帳號</th>
                <!-- <th>鹽巴</th> -->
                <!-- <th>密碼</th> -->
                <th>公司</th>
                <th>權限</th>
                <th>編輯</th>
                <th>刪除</th>
            </tr>
            <tbody>
                <% for ( var i = 0 ; i < data.length ; i++){ %>
                <tr>
                    <td>
                        <%= data[i].m_id  %>
                    </td>
                    <!-- <td>
                            <%= data[i].m_salt  %>
                        </td> -->
                    <!-- <td>
                            <%= data[i].m_passwordhash  %>
                        </td> -->
                    <td>
                        <%= data[i].m_company  %>
                    </td>
                    <td>
                        <%= data[i].m_permission  %>
                    </td>
                    <td>
                        <button type="button" class="btn btn-success" name="edit" value="Edit"
                            onclick="Edit('<%= data[i].m_id  %>');">Edit</button>
                        <!-- <input type="button" name="edit" value="Edit" onclick="Edit('<%= data[i].m_id  %>');" /> -->
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger" name="delete" value="Delete"
                            onclick="Delete('<%= data[i].m_id  %>');">Delete</button>
                        <!-- <input type="button" name="delete" value="Delete" onclick="Delete('<%= data[i].m_id  %>');" /> -->
                    </td>
                    <!-- onclick="Edit('<%= data[i].id  %>');" -->
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>

    <!-- 前端使用者管理區 -->
    <div class="tableTitle bg-primary"
        style="width:100%;height:50px;line-height:50px;text-align: center;font-size:20px;color:white;border-top:0.5px solid white;">
        <span style="margin-left:15px;">前台使用者管理</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <tr class="bg-primary" style="color:white;">
                <th>姓名</th>
                <th>Email</th>
                <th>身分證字號</th>
                <th>身分證正面</th>
                <th>身分證反面</th>
                <th>存摺照片</th>
                <th>手機</th>
                <th>以太坊地址</th>
                <th>資產合約地址</th>
                <th>多重簽章合約地址</th>
                <th>狀態</th>
                <th>審核通過</th>
            </tr>
            <tbody>
                <% console.log(FrontEnd_data) %>
                <% for ( var i = 0 ; i < FrontEnd_data.length ; i++){ %>
                <tr>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_name  %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_email  %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_identityNumber  %>
                    </td>
                    <td class="align-middle">
                        <%if (FrontEnd_data[i].u_imagef != null && FrontEnd_data[i].u_imagef !="") { %>
                        <p style="width:150px;"></p>
                        <img src="http://127.0.0.1:3000/<%= FrontEnd_data[i].u_imagef %>" alt="" style="width:100%;">
                        <% } %>
                    </td>
                    <td class="align-middle">
                        <%if (FrontEnd_data[i].u_imageb != null && FrontEnd_data[i].u_imageb !="") { %>
                        <p style="width:150px;"></p>
                        <img src="http://127.0.0.1:3000/<%= FrontEnd_data[i].u_imageb %>" alt="" style="width:100%;">
                        <% } %>
                    </td>
                    <td class="align-middle">
                        <%if (FrontEnd_data[i].u_bankBooklet != null && FrontEnd_data[i].u_bankBooklet !="") { %>
                        <p style="width:150px;"></p>
                        <img src="http://127.0.0.1:3000/<%= FrontEnd_data[i].u_bankBooklet %>" alt=""
                            style="width:100%;">
                        <% } %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_cellphone  %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_eth_add  %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_assetbookContractAddress  %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_multisigContractAddress  %>
                    </td>
                    <td class="align-middle">
                        <%= FrontEnd_data[i].u_verify_status  %>
                    </td>
                    <td class="align-middle">
                        <button type="button" id="approve" class="btn btn-success" name="Approve" value="Approve"
                            onclick="Approve('<%= FrontEnd_data[i].u_identityNumber %>','<%= FrontEnd_data[i].u_email %>','<%= FrontEnd_data[i].u_eth_add %>');">Approve</button>
                    </td>
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>

    <!-- <scrip src="/js/SignOut.js"></script> -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="/js/SignOut.js"></script>
    <script src="/js/DeployAccount.js"></script>


    <script>
        function Edit(ID) {
            window.location.href = "/BackendUser/EditBackendUser?ID=" + ID;
        }
        function Delete(ID) {
            var rs = confirm('Confirm to delete?');
            if (rs) {
                window.location.href = "/BackendUser/DeleteBackendUser?ID=" + ID;
            }
        }

        function Approve(ID, email, ethAddr) {
            console.log(ethAddr);
            let platformContractAddr = "0x855D969CeBb094DA1505De9af407100e35A292f6";

            console.log("multiSigContract deploying...");
            $.post("http://localhost:3000/MultiSigContractAPI/deploy", {
                platform: platformContractAddr,
                assetOwner: "0x17200B9d6F3D0ABBEccB0e451f50f7c6ed98b5DB",//ethAddr,(key chain開發未完成)
            }, function (result) {
                console.log(result);
                console.log(result.contractAddress);
                let multiSigContractAddr = result.contractAddress;

                if (result.status == true) {
                    /*部署assetContract*/
                    console.log("assetBookContract deploying...");
                    $.post("http://localhost:3000/AssetBookContractAPI/deploy", {
                        assetOwner: "0x17200B9d6F3D0ABBEccB0e451f50f7c6ed98b5DB",//ethAddr,(key chain開發未完成)
                        multiSigContractAddr: multiSigContractAddr,
                        platformContractAddr: platformContractAddr
                    }, function (result) {
                        //var result = JSON.parse(resultJSON);
                        console.log(result);
                        console.log(result.contractAddress);

                        /*檢查是否部署成功*/
                        if (result.status == true) {
                            let time = 201903110000;
                            /*部署成功後，註冊會員白名單*/
                            console.log("registering...");
                            $.post("http://localhost:3000/RegistryContractAPI/addUser", {
                                u_id: ID,
                                assetAddr: result.contractAddress,
                                ethAddr: ethAddr,
                                time: time
                            }, function (result) {
                                //var result = JSON.parse(resultJSON);
                                console.log(result);

                                /*檢查是否註冊會員白名單成功*/
                                if (result.result.status == true) {
                                    /*註冊會員白名單成功後，取得會員資訊*/
                                    $.get("http://localhost:3000/RegistryContractAPI/userInfo", {
                                        u_id: ID,
                                    }, function (result) {
                                        //var result = JSON.parse(resultJSON);
                                        console.log(result.userInfo);
                                        console.log(result.userInfo.uid);
                                        console.log(result.userInfo.assetCtAddr);
                                        console.log(result.userInfo.extoAddr);
                                        console.log(result.userInfo.userStatus);
                                        $.post("http://localhost:3000/RegistryContractAPI/updateUser", {
                                            email: email,
                                            assetContractAddr: result.userInfo.assetCtAddr,
                                            status: result.userInfo.accountStatus,
                                            ethAddr: result.userInfo.extoAddr,
                                            multiSigContractAddr: multiSigContractAddr
                                        }, function (result) {
                                            //var result = JSON.parse(resultJSON);
                                            console.log(result);
                                            //location.reload();
                                        });
                                    });
                                }
                            });
                        }
                    });
                }
            });

        }
    </script>

</body>

</html>